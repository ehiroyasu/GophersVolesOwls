---
title: "Varied Parameter Simulations"
author: "Elizabeth Hiroyasu"
date: "November 22, 2016"
output: html_document
---

To look at the sensitivity of the prey population to the model parameters, we can run the model for a variety of different parameters and look how the curve changes. For this simulation, we will set a variety of r values for population runs.


```{r, echo=FALSE, warning=FALSE, message=FALSE}
setwd("../GophersVolesOwls")
library(devtools)
library(roxygen2)
load_all("owls")
library(owls)

library(popbio)
library(deSolve)
library(plyr)
library(dplyr)
library(reshape)
library(ggplot2)
library(gridExtra)
library(grid)
library(cowplot)
```

From the literature, we have obtained estimates of the minimum, maximum, and average population matrices of gopher populations.
```{r}
stages = c("Juvenile", "SubAdult", "Adult")
gopher_min<-matrix(data=c(0, 2.40,5.35, 0.5, 0, 0, 0, 0.357, 0.25),  
                   nrow=3, ncol=3, byrow=TRUE,
                   dimnames=list(stages,stages))
gopher_min


gopher_avg<-matrix(data=c(0, 2.53, 7.78, 0.5, 0, 0, 0, 0.468, 0.449),  
                   nrow=3, ncol=3, byrow=TRUE,
                   dimnames=list(stages,stages))
gopher_avg

gopher_max<-matrix(data=c(0, 2.67, 10.2, 0.5, 0, 0, 0, 0.570, 0.67),  
                    nrow=3, ncol=3, byrow=TRUE,
                    dimnames=list(stages,stages))
gopher_max

r_min<-log(lambda(gopher_min))
r_avg<-log(lambda(gopher_avg))
r_max<-log(lambda(gopher_max))

r_gopher<-c(r_min, r_avg, r_max)
```


We can use the same pred_prey function created in our owls r-package, then use an ode solver to solve the derivatives.

The model requires multiple parameters:
r = growth rate of prey pop (gophers/season)
K_prey = carrying capacity of prey
alpha = attack rate of predator (or capture efficiency; the larger alpha is, the more the per capita growth rate of the prey population is depressed by the addition of a single predator)
beta= assimilation efficiency (efficiency of turning gophers into per capita growth)
delta = death rate of predator
k_max = maximum feeding rate (1/handling time)
D = half saturation constant (1/(alpha*handling time))

State variables:
N = starting population of prey 
P = starting population of predator


For this model, time is in terms of season (3 months), so each time interval is represented by a season and four seasons are equivalent to one year.
```{r}
#Parameters
alpha=1.68
beta = 0.002
delta=0.01
K_prey=175
h=1.39e-4
k_max=1/h
D=1/(alpha*h)
r=r_gopher
parameters <- c(r, alpha, beta, delta, K_prey, k_max, D)


#State variables:
N=c(175, 175, 175, 175, 175,
    100, 100, 100, 100, 100,
    50, 50, 50, 50, 50,
    25, 25, 25, 25, 25)

P=c(0.2, 0.4, 0.6, 0.95, 2.0, 
    0.2, 0.4, 0.6, 0.95, 2.0,
    0.2, 0.4, 0.6, 0.95, 2.0,
    0.2, 0.4, 0.6, 0.95, 2.0)
state<-cbind(N, P)
times<- seq(0, 20, by=1)
```

We can then run simulations for these various lists of r values while varying predator density.
```{r, echo=FALSE}
test_sim<-predprey_sim(times=times, state=state, r=r)
sim.df<-df_sim(sim=test_sim, r=r)

run<-sort(rep(1:(length(N)*length(r)), times=length(times)))
sim.df$run<-run
```

Then, plotting the prey density over time by each N.
```{r, echo=FALSE, warning=FALSE}
n175.sim<-lsplit(sim=test_sim, n=1:5, r=r)
n175<-df_sim(sim=n175.sim, r=r)

p1<-plot_n(n175[[1]], r[1])
p2<-plot_n(n175[[2]], r[2])
p3<-plot_n(n175[[3]], r[3])
legend <- get_legend(p1)

grid.arrange(grobs=list(p1+theme(legend.position="none"), p2+theme(legend.position="none"), p3+theme(legend.position="none"),legend), nrow=2, top=textGrob("Prey Density Over Time", gp=gpar(fontface="bold", fontsize=6, cex=3)))

n100.sim<-lsplit(sim=test_sim, n=6:10, r=r)
n100<-df_sim(sim=n100.sim, r=r)
p1<-plot_n(n100[[1]], r[1])
p2<-plot_n(n100[[2]], r[2])
p3<-plot_n(n100[[3]], r[3])
legend <- get_legend(p1)

grid.arrange(grobs=list(p1+theme(legend.position="none"), p2+theme(legend.position="none"), p3+theme(legend.position="none"),legend), nrow=2, top=textGrob("Prey Density Over Time", gp=gpar(fontface="bold", fontsize=6, cex=3)))


n50.sim<-lsplit(sim=test_sim, n=11:15, r=r)
n50<-df_sim(sim=n50.sim, r=r)
p1<-plot_n(n50[[1]], r[1])
p2<-plot_n(n50[[2]], r[2])
p3<-plot_n(n50[[3]], r[3])
legend <- get_legend(p1)

grid.arrange(grobs=list(p1+theme(legend.position="none"), p2+theme(legend.position="none"), p3+theme(legend.position="none"),legend), nrow=2, top=textGrob("Prey Density Over Time", gp=gpar(fontface="bold", fontsize=6, cex=3)))

n25.sim<-lsplit(sim=test_sim, n=16:20, r=r)
n25<-df_sim(sim=n25.sim, r=r)
p1<-plot_n(n25[[1]], r[1])
p2<-plot_n(n25[[2]], r[2])
p3<-plot_n(n25[[3]], r[3])
legend <- get_legend(p1)

grid.arrange(grobs=list(p1+theme(legend.position="none"), p2+theme(legend.position="none"), p3+theme(legend.position="none"),legend), nrow=2, top=textGrob("Prey Density Over Time", gp=gpar(fontface="bold", fontsize=6, cex=3)))

```

We can also look at how the final population density of the prey species varies by changes in parameter.
```{r, echo=FALSE}

diff.175<-percent_diff(n175.sim, r=r)
p175<-plot_diff(diff=diff.175, N=N, j=1)

diff.100<-percent_diff(n100.sim, r=r)
p100<-plot_diff(diff.100, N=N, j=2)

diff.50<-percent_diff(n50.sim, r=r)
p50<-plot_diff(diff=diff.50, N=N, j=3)

diff.25<-percent_diff(n25.sim, r=r)
p25<-plot_diff(diff=diff.25, N=N, j=4)

legend<-get_legend(p175)

grid.arrange(grobs=list(p175+theme(legend.position="none"), 
                        p100+theme(legend.position="none"), 
                        p50+theme(legend.position="none"), 
                        p25+theme(legend.position="none"),
                        legend), nrow=3, top=textGrob("Percent Change by Predator Density", 
                                                      gp=gpar(fontface="bold", fontsize=6, cex=3)),
             layout_matrix = rbind(c(1,2), c(3,4), c(5,5)), heights = c(2.5, 2.5, 0.2))

```


